!function(t,e){"object"==typeof exports&&"function"==typeof require?module.exports=e(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],function(n,r){return e(n||t._,r||t.Backbone)}):e(_,Backbone)}(this,function(t,e){function n(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function r(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}return e.LocalStorage=window.Store=function(t){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=t;var e=this.localStorage().getItem(this.name);this.records=e&&e.split(",")||[]},t.extend(e.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(t){return t.id||(t.id=r(),t.set(t.idAttribute,t.id)),this.localStorage().setItem(this.name+"-"+t.id,JSON.stringify(t)),this.records.push(t.id.toString()),this.save(),this.find(t)},update:function(e){return this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),t.include(this.records,e.id.toString())||this.records.push(e.id.toString()),this.save(),this.find(e)},find:function(t){return this.jsonData(this.localStorage().getItem(this.name+"-"+t.id))},findAll:function(){return(t.chain||t)(this.records).map(function(t){return this.jsonData(this.localStorage().getItem(this.name+"-"+t))},this).compact().value()},destroy:function(e){return e.isNew()?!1:(this.localStorage().removeItem(this.name+"-"+e.id),this.records=t.reject(this.records,function(t){return t===e.id.toString()}),this.save(),e)},localStorage:function(){return localStorage},jsonData:function(t){return t&&JSON.parse(t)},_clear:function(){var e=this.localStorage(),n=new RegExp("^"+this.name+"-");e.removeItem(this.name),(t.chain||t)(e).keys().filter(function(t){return n.test(t)}).each(function(t){e.removeItem(t)}),this.records.length=0},_storageSize:function(){return this.localStorage().length}}),e.LocalStorage.sync=window.Store.sync=e.localSync=function(t,n,r){var i,o,s=n.localStorage||n.collection.localStorage,a=e.$.Deferred&&e.$.Deferred();try{switch(t){case"read":i=void 0!=n.id?s.find(n):s.findAll();break;case"create":i=s.create(n);break;case"update":i=s.update(n);break;case"delete":i=s.destroy(n)}}catch(u){o=22===u.code&&0===s._storageSize()?"Private browsing is unsupported":u.message}return i?(r&&r.success&&("0.9.10"===e.VERSION?r.success(n,i,r):r.success(i)),a&&a.resolve(i)):(o=o?o:"Record Not Found",r&&r.error&&("0.9.10"===e.VERSION?r.error(n,o,r):r.error(o)),a&&a.reject(o)),r&&r.complete&&r.complete(i),a&&a.promise()},e.ajaxSync=e.sync,e.getSyncMethod=function(t){return t.localStorage||t.collection&&t.collection.localStorage?e.localSync:e.ajaxSync},e.sync=function(t,n,r){return e.getSyncMethod(n).apply(this,[t,n,r])},e.LocalStorage});